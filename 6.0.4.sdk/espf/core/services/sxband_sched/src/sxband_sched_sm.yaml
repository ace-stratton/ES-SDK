---
sxband_sched_sm:
    states:
        - not_init:
            transitions:
                - init:
                    - { event: init }
            attributes:
               on_entry: False
               on_exit: False

        - init:
            states:
              - idle:
                  transitions:
                    - in_progress:
                       - { event: start, guard: is_valid_context, action: reset_cmd_iterator }
                  attributes:
                    on_entry: False
                    on_exit: False

              - in_progress:
                  transitions:
                     - idle:
                        - { event: stop, action: deinit_sm_context_stop }
                     - idle:
                        - { event: failure_check, guard: general_failure, action: deinit_sm_context_fail }

                  states:
                    - file_tx_in_progress:
                       states:
                          - wait_file_tx:
                             transitions:
                                - file_tx_finished:
                                   - { event: cmd_confirmed, action: update_cmd_status }
                                - file_tx_finished:
                                   - { event: "__periodic", guard: is_cmd_timeout_elapsed, action: update_cmd_status_timeout }
                             attributes:
                                on_exit: False
                          - file_tx_finished:
                             transitions:
                                - wait_file_tx:
                                   - { event: "__periodic", guard: has_more_files, action: send_next_file_cmd }
                                - prepare_cmd:
                                   - { event: "__periodic", guard: more_cmd_to_process, action: load_next_cmd }
                                - idle:
                                   - { event: "__periodic", guard: no_more_commands, action: deinit_sm_context }
                             attributes:
                                on_exit: False
                                on_entry: True
                       attributes:
                           initial: wait_file_tx
                           on_entry: False
                    - prepare_cmd:
                       transitions:
                          - idle:
                             - { event: "__periodic", guard: no_more_commands, action: deinit_sm_context }
                          - wait_cmd_result:
                             - { event: "__periodic", guard: is_regular_cmd, action: send_next_cmd }
                          - file_tx_in_progress:
                             - { event: "__periodic", guard: can_iterate_files_with_pattern, action: send_first_file_cmd }
                          - "__self":
                             - { event: "__periodic", guard: empty_pattern, action: load_next_cmd_empty_pattern }
                       attributes:
                           on_entry: True
                           on_exit: False

                    - wait_cmd_result:
                       transitions:
                          - cmd_finished:
                             - { event: cmd_confirmed, action: update_cmd_status }
                          - cmd_finished:
                             - { event: "__periodic", guard: is_cmd_timeout_elapsed, action: update_cmd_status_timeout }
                       attributes:
                          on_entry: False
                          on_exit: False

                    - cmd_finished:
                       transitions:
                          - prepare_cmd:
                             - { event: "__periodic", guard: has_more_commands, action: load_next_cmd }
                          - idle:
                             - { event: "__periodic", guard: no_more_commands, action: deinit_sm_context }
                       attributes:
                          on_exit: False

                  attributes:
                    on_exit: True
                    on_entry: True
                    initial: prepare_cmd

            attributes:
              on_entry: False
              on_exit: False
              initial: idle

    attributes:
        initial: not_init
