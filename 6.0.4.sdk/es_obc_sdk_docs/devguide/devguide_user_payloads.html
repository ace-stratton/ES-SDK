
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://endurosat.com/devguide/devguide_user_payloads.html">
      
      
        <link rel="prev" href="devguide_conops.html">
      
      
        <link rel="next" href="devguide_aocs.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>User Payloads - EnduroSat On-Board Computer SDK Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implement-a-thruster-payload-handler" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="EnduroSat On-Board Computer SDK Documentation" class="md-header__button md-logo" aria-label="EnduroSat On-Board Computer SDK Documentation" data-md-component="logo">
      
  <img src="../EnduroSat_horLogo_symbol@2x-min.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EnduroSat On-Board Computer SDK Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              User Payloads
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../quickstart.html" class="md-tabs__link">
        
  
    
  
  Quick-start Guide

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="hldesign.html" class="md-tabs__link">
          
  
  Developer's Guide

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../assets/src-docs/index.html" class="md-tabs__link">
        
  
    
  
  Code Reference

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../reference_docs.html" class="md-tabs__link">
        
  
    
  
  Reference documents

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../change_history.html" class="md-tabs__link">
        
  
    
  
  Change history

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../contacts.html" class="md-tabs__link">
        
  
    
  
  Contacts

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="EnduroSat On-Board Computer SDK Documentation" class="md-nav__button md-logo" aria-label="EnduroSat On-Board Computer SDK Documentation" data-md-component="logo">
      
  <img src="../EnduroSat_horLogo_symbol@2x-min.png" alt="logo">

    </a>
    EnduroSat On-Board Computer SDK Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick-start Guide
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Developer's Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Developer's Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="hldesign.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    High-Level Design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_dirstructure.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Directory structure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_cmake.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build structure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OBC configuration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            OBC configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_buildcfg.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build-time configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_sysconfig.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run-time configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" checked>
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Development recipes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Development recipes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_newcomp.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extending the SDK with new components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_esps_cmd_extend.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extending the set of OBC supported commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_fwupd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bootloader and firmware updates handling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_debugtrace.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debug and trace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_assertions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Assertions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_datacache.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Cache
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_telemetry.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telemetry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_micropython.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MicroPython
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_es_adcs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EnduroSat ADCS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_10" checked>
        
          
          <label class="md-nav__link" for="__nav_3_5_10" id="__nav_3_5_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Operations
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_5_10">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_conops.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Concept of Operations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    User Payloads
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="devguide_user_payloads.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    User Payloads
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implement-a-thruster-payload-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Implement a thruster payload handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verifying-the-payload-basic-operation" class="md-nav__link">
    <span class="md-ellipsis">
      Verifying the payload basic operation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specifying-payload-start-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying payload start parameters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-custom-thruster-maneuvers" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing custom thruster maneuvers
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_aocs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Attitude and Orbit Control
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_payload_scheduler.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Payload Scheduler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_cubeadcs_gen2_service.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CubeADCS Gen2 Service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_operations_guide.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Operations Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_pm.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Performance monitor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Connectivity
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Connectivity
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="devguide_eth.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ethernet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../assets/src-docs/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code Reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference_docs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference documents
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../change_history.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Change history
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contacts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contacts
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>User Payloads</h1>

<p>The <strong>Payload Modes</strong> of the <abbr title="Concept of Operations">ConOps</abbr> is responsible to manage the correct activation, control and deactivation of the integrated payloads.</p>
<p>The <abbr title="Software">SW</abbr> modules orchestrating the payloads are listed below:</p>
<ul>
<li>
<p><code>payload_scheduler</code> <em>(espf/core/services/payload_scheduler)</em></p>
<ul>
<li>Responsible for the activation of time-based schedule entries by taking into account the given payload boot time and also <abbr title="Attitude Determination and Control System">ADCS</abbr> pointing time. This means, your payload will be activated a bit earlier so that actual operation can start as soon as the specified schedule time ticks in. The <code>payload_scheduler</code> does not start the payload on its own. It just notifies the <code>conops</code> module that there is a payload ready for activation.</li>
</ul>
</li>
<li>
<p><code>conops</code> <em>(espf/app/conops)</em></p>
<ul>
<li>Responsible for handling the <abbr title="On-board Computer">OBC</abbr> operational states. If the <abbr title="On-board Computer">OBC</abbr> resides in the <code>Idle</code> state and the <code>payload_scheduler</code> requests a payload activation, <code>conops</code> will check if the operating conditions allow this activation and will trigger or reject the operation accordingly. Activating the payload is requested from the <code>payload_ctrl</code> module <em>(see below for details)</em>.</li>
</ul>
</li>
<li>
<p><code>payload_ctrl</code> <em>(espf/core/services/payload_ctrl)</em></p>
<ul>
<li>Handles the communication with the individual payloads in the system through a unified interface defined in  the <code>if_payload_control.h</code> header. Every payload integrated in the system must implement this interface so that it can be controlled by the mechanism described here. <code>payload_ctrl</code> will also make sure the correct <abbr title="Attitude and Orbit Control System">AOCS</abbr> pointing is established before starting the payload. If multiple payloads should be started at the same time or in overlapping time intervals, it is possible, provided they share the same <abbr title="Attitude Determination and Control System">ADCS</abbr> pointing requirements. Otherwise, only the first payload will start and the rest of the payload activations will be ignored unless scheduled again at a later time by themselves or along with other payloads sharing the same pointing mode parameters.</li>
</ul>
</li>
<li>
<p><code>aocs</code> <em>(espf/core/services/aocs)</em></p>
<ul>
<li>Controls the satellite pointing.</li>
</ul>
</li>
<li>
<p><code>user_payload_1</code> … <code>user_payload_n</code></p>
<ul>
<li>These <abbr title="Software">SW</abbr> modules are responsible to handle the life cycle of the individual payloads. All of them shall implement the <code>if_payload_control.h</code> interface. A payload <abbr title="Software">SW</abbr> module usually controls a <abbr title="Hardware">HW</abbr> device to enable operation from the ground but in fact, it could provide any implementation which you want to be able to execute through the on-board scheduling mechanism. The payload start interface is very generic and can be used to execute simple commands implemented by your payload as well as provision your payload with operational data residing in a file which has been uploaded to the satellite before running the schedule. The format of the file is payload-specific and it is a responsibility of the payload implementation to interpret the file and perform action based on its content.</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can use <code>payload_dummy.c</code> and <code>payload_dummy.h</code> files located in the <code>espf/core/services/payload_ctrl/src</code> folder as a starting template for your new payload implementation.</p>
</div>
<p><center><a class="glightbox" href="../assets/plantuml/img/payload_control_mechanism.svg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="ConOps_Payload_Mechanism" src="../assets/plantuml/img/payload_control_mechanism.svg" /></a></center></p>
<p>Here is the basic sequence followed when a new schedule file is uploaded and executed:</p>
<p><center><a class="glightbox" href="../assets/plantuml/img/payload_control_seq.svg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="ConOps_Payload_Sequence" src="../assets/plantuml/img/payload_control_seq.svg" /></a></center></p>
<h2 id="implement-a-thruster-payload-handler">Implement a thruster payload handler</h2>
<p>Now let's take a short example on how to extend the payload control mechanism to handle an imaginary thruster payload. For brevity we will use the name <code>THR</code> below when naming different files and folders.</p>
<p>The general steps are:</p>
<ol>
<li>
<p>Create a folder for your new payload implementation in the <abbr title="On-board Computer">OBC</abbr> SDK project <em>(let's put this under <code>espf/core/services/pl_thr</code>)</em>.</p>
</li>
<li>
<p>Copy the dummy payload templates from <code>espf/core/services/payload_ctrl/src</code> to the newly created folder and rename them to <code>pl_thr.c</code> and <code>pl_thr.h</code> respectively.</p>
</li>
</ol>
<p>Now let's take a quick look at the file content and focus on the important aspects of integrating our new payload.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">pl_thr.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#ifndef PL_THR_H</span>

<span class="cp">#define PL_THR_H</span>

<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="p">{</span>
<span class="cp">#endif  </span><span class="c1">// __cplusplus</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;if_payload_control.h&quot;</span>

<span class="k">extern</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">pl_control_if_t</span><span class="w"> </span><span class="n">pl_thr_if</span><span class="p">;</span>

<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// __cplusplus</span>
<span class="cp">#endif </span><span class="c1">// PL_THR_H</span>
</code></pre></div></td></tr></table></div>
<p>This header file exports the user payload interface instance at line <code>12</code>. This instance will then be referenced in the <abbr title="On-board Computer">OBC</abbr> payload configuration.</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">pl_thr.c</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;es_cdef.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;if_payload_control.h&quot;</span>

<span class="k">static</span><span class="w"> </span><span class="n">p_pl_event_notify_t</span><span class="w"> </span><span class="n">p_event_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p_pl_event_notify_t</span><span class="p">)</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_NOT_INIT</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fire_event</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="n">to_state</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p_event_cbk</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">p_event_cbk</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">to_state</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_init_cfg</span><span class="p">,</span>
<span class="w">                                      </span><span class="k">const</span><span class="w"> </span><span class="n">p_pl_event_notify_t</span><span class="w"> </span><span class="n">p_event_notify_cb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_init_cfg</span><span class="p">;</span>

<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STOPPED</span><span class="p">;</span>
<span class="w">    </span><span class="n">p_event_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_event_notify_cb</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_deinit</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_NOT_INIT</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STARTED</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_stop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">pl_op_stop_mode_t</span><span class="w"> </span><span class="n">stop_mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STOPPED</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="nf">pl_thr_get_active_state</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">current_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">pl_thr_get_last_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// This is the Thruster payload interface which will be referenced by the</span>
<span class="c1">// system payload configuration. Only this part of the payload implementation must</span>
<span class="c1">// remain public.</span>
<span class="k">const</span><span class="w"> </span><span class="n">pl_control_if_t</span><span class="w"> </span><span class="n">pl_thr_if</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_init</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">deinit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_deinit</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_start</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_stop</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_get_active_state</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_last_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_get_last_error</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
The <code>pl_thr.c</code> file currently contains a very basic user payload implementation:</p>
<ul>
<li>It tracks the payload state in relation to the control commands received through the <code>pl_thr_if</code> interface.</li>
<li>It returns a default error status.</li>
<li>It reports the correct internal state of the payload.</li>
<li>It notifies the payload subsystem about state changes if a <code>p_event_notify_cb</code> callback was provided during initialization.</li>
</ul>
<p>Last but not least, we have to create a CMake file for our implementation and to extend the <abbr title="On-board Computer">OBC</abbr> SDK build to include our new module in the build process.</p>
<p>Paste the following code in a <code>CMakeLists.txt</code> file under the <code>espf/core/services/pl_thr</code> folder.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">set</span><span class="p">(</span><span class="s">make_target</span><span class="w"> </span><span class="s2">&quot;pl_thr&quot;</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">C</span><span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">STATIC</span>
<span class="w">    </span><span class="s2">&quot;src/pl_thr.c&quot;</span>
<span class="p">)</span>

<span class="nb">list</span><span class="p">(</span>
<span class="w">    </span><span class="s">APPEND</span><span class="w"> </span><span class="s">module_includes</span>
<span class="w">    </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/inc&quot;</span>
<span class="p">)</span>

<span class="nb">target_include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">module_includes</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="o">${</span><span class="nv">ROOT_INCLUDES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">ROOT_COMPILE_DEFS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">ROOT_COMPILE_OPTIONS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">target_link_options</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">ROOT_LINK_OPTIONS</span><span class="o">}</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>This file basically includes our <code>pl_thr.c</code> file in the build (line <code>5</code>), inherits all build options from the parent project through <code>${ROOT_COMPILE_DEFS}</code> and <code>${ROOT_LINK_OPTIONS}</code> (lines <code>13-16</code>), and provides the include path to the <code>pl_thr.h</code> file for any other modules linking to this one (line <code>10</code>).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It is a rare event that a new software module relies only on itself, so if you depend on other modules in the system, you have to add those as follows:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">timer</span><span class="w"> </span><span class="s">libtrace</span><span class="w"> </span><span class="s">...</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
</div>
<p>For now, however, we will keep this simple. And before bringing-in more functionality, let's add our new payload interface to the system payloads list so that it can be directly managed by the <code>payload_ctrl</code>. After testing the basic operation, we will extend the functionality to support some more useful actions.</p>
<ul>
<li>Open <code>espf/config/payload_ctrl/payload_cfg_user.h</code> and edit the <code>payload_ctrl_payload_t</code> enumeration to include the new payload ID <em>(line <code>4</code> below)</em>.</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">payload_cfg_user.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">...</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PAYLOAD_SX_BAND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">PAYLOAD_THR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">            </span><span class="c1">// &lt;-- our new payload</span>
<span class="w">    </span><span class="n">PAYLOAD_COUNT</span>
<span class="p">}</span><span class="w"> </span><span class="n">payload_ctrl_payload_t</span><span class="p">;</span>
<span class="p">...</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>Now we have to register the <code>pl_thr_if</code> to the list of supported payload interfaces. Edit <code>espf/config/payload_ctrl/payload_cfg_user.c</code> as follows:</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">payload_cfg_user.c</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;pl_thr.h&quot;</span><span class="c1">     // include the payload header here</span>

<span class="p">...</span>

<span class="c1">// This is a simple adapter function between the if_payload_control.h callback interface and the</span>
<span class="c1">// payload_ctrl interface which doesn&#39;t operate directly with payload instances (e.g. if multiple instances</span>
<span class="c1">// are supported by your payload).</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">payload_pl_thr_state_notify</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="n">to_state</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// just map the instance_id argument to the correct payload_ctrl_payload_t identifier and</span>
<span class="w">    </span><span class="c1">// call the payload_ctrl to inform it of the state change event</span>
<span class="w">    </span><span class="n">payload_ctrl_event_notify</span><span class="p">(</span><span class="n">PAYLOAD_THR</span><span class="p">,</span><span class="w"> </span><span class="n">to_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="k">const</span><span class="w"> </span><span class="n">payload_immutable_cfg_t</span><span class="w"> </span><span class="n">payload_cfg</span><span class="p">[</span><span class="n">PAYLOAD_COUNT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// PAYLOAD_SX_BAND</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">p_pl_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sxband_pl_ctrl_if</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">internal_inst_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">init_config</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">          </span><span class="p">.</span><span class="n">p_config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">          </span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">.</span><span class="n">p_pl_notif_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">payload_sxband_state_notify</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// PAYLOAD_THR &lt;== our new payload entry</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">p_pl_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pl_thr_if</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">internal_inst_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">init_config</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">          </span><span class="p">.</span><span class="n">p_config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">          </span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">.</span><span class="n">p_pl_notif_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">payload_pl_thr_state_notify</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="p">...</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>The final integration step is to extend the <abbr title="On-board Computer">OBC</abbr> SDK build to include the thruster payload. Open <code>espf/CMakeLists.txt</code> and add the <code>pl_thr</code> module as follows <em>(line <code>8</code> and <code>30</code> below)</em>:</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">config/datacache</span><span class="w"> </span><span class="s">datacache</span><span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">core/lib/crc</span><span class="w"> </span><span class="s">crc</span><span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">core/lib/cbuf</span><span class="w"> </span><span class="s">cbuf</span><span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">core/lib/cobs_inplace</span><span class="w"> </span><span class="s">cobs_inplace</span><span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">core/lib/trace</span><span class="w"> </span><span class="s">libtrace</span><span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">core/lib/sys_printf</span><span class="w"> </span><span class="s">sys_printf</span><span class="p">)</span>
<span class="err">...</span>
<span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">core/services/pl_thr</span><span class="w"> </span><span class="s">pl_thr</span><span class="p">)</span><span class="w">       </span><span class="c"># &lt;-- tell CMake to build our new module</span>

<span class="err">...</span>

<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">libs</span>
<span class="w">    </span><span class="s">payload_ctrl</span>
<span class="w">    </span><span class="s">SGP4</span>
<span class="w">    </span><span class="s">COBS</span>
<span class="w">    </span><span class="s">hsm</span>
<span class="w">    </span><span class="s">timer</span>
<span class="w">    </span><span class="s">eps_ctrl</span>
<span class="w">    </span><span class="s">datetime</span>
<span class="w">    </span><span class="s">csp</span>
<span class="w">    </span><span class="s">sys_time</span>
<span class="w">    </span><span class="s">datacache</span>
<span class="w">    </span><span class="s">crc</span>
<span class="w">    </span><span class="s">nvm</span>
<span class="w">    </span><span class="s">nvm_cfg</span>
<span class="w">    </span><span class="s">cbuf</span>
<span class="w">    </span><span class="s">cobs_inplace</span>
<span class="w">    </span><span class="s">libtrace</span>
<span class="w">    </span><span class="s">sys_printf</span>
<span class="w">    </span><span class="s">pl_thr</span><span class="w">           </span><span class="c"># &lt;-- add the payload module to the list of SDK libraries</span>
<span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Build your project and flash it on the <abbr title="On-board Computer">OBC</abbr> board to check our initial payload integration.</p>
<h2 id="verifying-the-payload-basic-operation">Verifying the payload basic operation</h2>
<p>After customizing the base user payload template and registering it to the list of system payloads, <code>payload_ctrl</code> should now start managing your payload without any additional programming on your side. What you should observe at first is that your payload gets initialized right after <abbr title="On-board Computer">OBC</abbr> boot. Place a breakpoint on the <code>pl_thr_init</code> operation in <code>pl_thr.c</code> and see if it gets called when you run the project.</p>
<p><a class="glightbox" href="../assets/img/user_payload_init_hook_check.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Verifying init payload hook is called" src="../assets/img/user_payload_init_hook_check.gif" /></a></p>
<p>Now as the <code>plp_thr_init</code> hook gets called, let's try to activate our thruster payload using the standard <code>Payload_Control.fidl</code> interface provided as part of the <abbr title="On-board Computer">OBC</abbr> SDK under the <code>espf/core/fidl/obc/fp</code> folder. It serves as a basic user payload testing surface enabling easy start/stop control for payloads as well as querying their state. For anything more complicated, you shall implement your own payload-specific <abbr title="Franca Interface Definition Language">FIDL</abbr> interface to support custom payload configurations for example. You can refer to the <a href="devguide_newcomp.html#the-anatomy-of-a-typical-obc-sdk-cmakeliststxt-file">Extending the SDK with new components</a> chapter for additional examples how to do that for your new component.</p>
<p>Back to our example, we will load the <code>Payload_Control.fidl</code> <abbr title="Application Programming Interface">API</abbr> into <abbr title="Space Development Environment (an EnduroSat tool used for module communication over different interfaces)">SDE</abbr> and we will attempt to control our payload (which has a payload ID of <code>1</code> as defined in <code>payload_cfg_user.h</code> above) and query its state. Calling <code>startPayload</code>/<code>stopPayload</code> <abbr title="Franca Interface Definition Language">FIDL</abbr> methods shall trigger our <code>pl_thr_start</code> and <code>pl_thr_stop</code> handlers respectively. Using the <code>getPayloadInfo</code> method shall properly report the thruster state.</p>
<p><a class="glightbox" href="../assets/img/user_payload_start_stop_query_demo.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Exercising user payload control via SDE" src="../assets/img/user_payload_start_stop_query_demo.gif" /></a></p>
<p>We have seen that basing our new implementation on the standard user payload template can quickly get us started on working with a new payload as part of the <abbr title="On-board Computer">OBC</abbr> SDK build. It also has out-of-the-box testing interface provided for the standard payload life-cycle operations. So far, so good, but one real-life thruster would need to perform more complicated handling in orbit, hence in the next chapters we will see how to provide more functions to it and also demonstrate how to call it with the on-board <abbr title="On-board Computer">OBC</abbr> scheduler. Read on...</p>
<h2 id="specifying-payload-start-parameters">Specifying payload start parameters</h2>
<p>At this time, our <code>pl_thr_start</code> operation is only changing the payload state and doesn't do anything useful. What would an engineer imagine a thruster needs to do in orbit is perhaps execution of a programmed sequence of maneuvers when it is started. It would be nice if we could schedule the sequence of maneuvers from the ground. Fortunately we can do this by utilizing the payload start configuration parameters provided by the <code>if_payload_control.h</code> interface we already implemented. Let's remember what the <code>pl_thr_start</code> function prototype looks like:</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="n">pl_thr_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
You should focus on the <code>p_start_cfg</code> argument. The <code>pl_config_t</code> type definition is the following:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p_config_data</span><span class="p">;</span><span class="w">        </span><span class="cm">/**&lt; a pointer to the payload-specific configuration data */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">        </span><span class="cm">/**&lt; size of the data pointed to by p_config_data */</span>
<span class="p">}</span><span class="w"> </span><span class="n">pl_config_t</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>As you can see, we can pass pretty much anything to the payload start function through this parameter since it doesn't define a concrete type for the <code>p_config_data</code>. The interpretation of this field is completely left to the payload implementation. <code>payload_ctrl</code> only makes sure the data is transparently forwarded to the respective payload handler. No processing or error checking is performed on this data on its way.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Please have in mind that currently the maximum size of the data which can be passed through the <code>p_config_data</code> argument is limited to the maximum size supported by the on-board <abbr title="On-board Computer">OBC</abbr> scheduler record. At the time of writing this guideline, this size is set to <code>16 bytes</code>.</p>
<p>The constraint comes from the <code>record_t::payload_args[]</code> field definition in <code>espf/core/services/payload_scheduler/payload_scheduler.h</code>.</p>
<p>In fact, the idea here is that if you need more than 16 bytes to configure your payload, it would be better to use a file-based configuration instead and just provide the file name here. Some adjustments to this size are possible in the next revisions of the <abbr title="On-board Computer">OBC</abbr> SDK but for now this limitation is also imposed by the <abbr title="EnduroSat Digital Ground Station">DGS</abbr> payload control operations as well.</p>
</div>
<p>As already noted, it is up to the user payload code designer to decide whether to use the <code>p_config_data</code> argument as a binary blob field to configure the payload start operation, or to provide here a file name which must be loaded and processed by the user payload directly.</p>
<p>For the sake of simplicity, we will not use files but instead implement a very simple maneuver scheme encoded in the <code>16-byte</code> <code>p_config_data</code> argument which will instruct our thruster what maneuvers to execute and in what order. Simplifying even further, each byte in <code>p_config_data</code> will encode a specific type of maneuver which will be held in execution for only 2 seconds. Once all maneuvers are executed, the payload will remain in execution of the last maneuver until stopped by the on-board scheduler. You should perhaps avoid this kind of implementation for a real satellite but for the purpose of demonstration that would be perfectly fine. Let's continue with our implementation according to the new requirements we just adopted for our payload.</p>
<h2 id="implementing-custom-thruster-maneuvers">Implementing custom thruster maneuvers</h2>
<p>We will define the list of maneuvers supported by our thruster as an enumeration like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/** @brief List of maneuvers supported by the thruster */</span>
<span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PL_THR_MAN_NONE</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_SGL_THRUST_SHORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_SGL_THRUST_LONG</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_DBL_THRUST_SHORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_DBL_THRUST_LONG</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_INCR_THRUST_HALF_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_INCR_THRUST_ONE_S</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">7</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Executing the maneuvers would be a long-term operation and thus we cannot execute this inside the <code>pl_thr_start</code> hook because we would block the <code>payload_ctrl</code> thread. The maneuver activation shall happen inside a dedicated <abbr title="Operating System">OS</abbr> thread. Let's create one:</p>
<ul>
<li>We will edit the list of includes in <code>pl_thr.c</code> to enable use of the <abbr title="Operating System">OS</abbr> APIs and also the <abbr title="On-board Computer">OBC</abbr> trace subsystem which we will use to indicate that our maneuvers are being executed. Add the following includes at the top of the file:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cmsis_os2.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;trace.h&quot;</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For <code>trace.h</code> support you also have to edit the <code>CMakeLists.txt</code> file to include the following line at the end:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">make_target</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">libtrace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
</div>
<ul>
<li>Now let's create an empty thruster <abbr title="Operating System">OS</abbr> thread by placing the following code in the <code>pl_thr.c</code> file:</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">osThreadId_t</span><span class="w"> </span><span class="n">thruster_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000U</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>The new thread needs to be initialized in the <code>pl_thr_init</code> function by adding the following code:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">osThreadAttr_t</span><span class="w"> </span><span class="n">task_attr</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">attr_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadDetached</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pl_thr_task&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">priority</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">osPriorityNormal</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cb_mem</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cb_size</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">stack_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">stack_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000U</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">thruster_task</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">thruster_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl_thr_task</span><span class="p">,</span>
<span class="w">                                    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                                    </span><span class="o">&amp;</span><span class="n">task_attr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>Now after building and flashing the <abbr title="On-board Computer">OBC</abbr> via the debugger, you should be able to verify the the <code>pl_thr_task</code> function is called by the <abbr title="Operating System">OS</abbr>. It is not doing much at this time but we will add our maneuver activation code in a few moments.</p>
<ul>
<li>
<p>Let's first define the list of supported thruster maneuvers and allocate some memory for the maneuvers sequence which we will accept as a payload argument when the <code>pl_thr_start</code> hook is called:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/** @brief List of maneuvers supported by the thruster */</span>
<span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PL_THR_MAN_NONE</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_SGL_THRUST_SHORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_SGL_THRUST_LONG</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_DBL_THRUST_SHORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_DBL_THRUST_LONG</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_INCR_THRUST_HALF_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_INCR_THRUST_ONE_S</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">7</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">];</span><span class="w">   </span><span class="cm">/**&lt; Maneuvers sequence to be executed by the payload */</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>A simple operation to execute our maneuvers would also be nice to have:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute_thr_maneuver</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">maneuver_names</span><span class="p">[</span><span class="n">PL_THR_MAN_MAX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;NONE&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;SGL_THRUST_SHORT&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;SGL_THRUST_LONG&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;DBL_THRUST_SHORT&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;DBL_THRUST_LONG&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;INCR_THRUST_HALF_S&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;INCR_THRUST_ONE_S&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">man_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PL_THR_MAN_MAX</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ES_TRACE_INFO</span><span class="p">(</span><span class="s">&quot;executing maneuver &#39;%s&#39;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maneuver_names</span><span class="p">[(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">man_id</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ES_TRACE_ERROR</span><span class="p">(</span><span class="s">&quot;invalid maneuver id &#39;%d&#39;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">man_id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
</ul>
<p>The <code>execute_thr_maneuver</code> function will only trace the execution of the supplied maneuvers by the start configuration parameter. For a real thruster, this would also be handling the <abbr title="Hardware">HW</abbr> control aspects of the execution but for our demonstration, it is completely sufficient.</p>
<ul>
<li>Now that we have all maneuver code in place, we need to properly process the start configuration parameter so that we can use it to trigger a specific sequence of maneuvers requested by <abbr title="EnduroSat Mission Control System (aka DGS)">MCS</abbr>. For this to work fine, we need to copy the start configuration data in the <code>maneuvers_seq</code> buffer which we statically allocated so that it can be processed later when our <code>pl_thr_task</code> function is scheduled by the <abbr title="Operating System">OS</abbr>. Add the following code to the <code>pl_thr_start</code> function:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">memcpy</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">,</span>
<span class="w">                  </span><span class="n">p_start_cfg</span><span class="o">-&gt;</span><span class="n">p_config_data</span><span class="p">,</span>
<span class="w">                  </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">fmin</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">),</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<img alt="❗" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2757.svg" title=":exclamation:" /> You would need the <code>math.h</code> include at the top of the file to resolve the <code>fmin()</code> function and the <code>string.h</code> include to resolve the <code>memcpy()</code> function.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>We are currently assuming that <code>p_start_cfg-&gt;p_config_data</code> points to a buffer of maneuvers as we defined it here. This must be ensured when preparing an on-board schedule file via <abbr title="EnduroSat Mission Control System (aka DGS)">MCS</abbr> or when requesting scheduler operations via the <code>ConOps.fidl::addNewScheduleRecord</code> method <em>(e.g. refer to the <code>payArgs</code> argument)</em>.</p>
</div>
<ul>
<li>
<p>We transferred the maneuver sequence into our internal buffer but we don't have any code in place to process it. Let's add this to our <code>pl_thr_task</code> function:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// currently unused</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_NONE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">execute_thr_maneuver</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]);</span>

<span class="w">                </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">2000U</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>If you are paying close attention to our implementation here, you probably already noticed some flaws. The task function is constantly processing the <code>maneuvers_seq</code> buffer but doesn't actually know if the buffer contains anything valid. What would also happen if the asynchronous <code>pl_thr_start</code> operation is called in the middle of our processing and replaces the content of the buffer? Alas, this can lead to any number of side effects we will observe as weird and most probably incorrect behavior of our maneuver execution. Moreover there is no guarantee our maneuver execution will run to completion which may be detrimental to the satellite operation. As we are currently focused on implementing a simple user payload operation, we still have to account for any possible race condition effects which may occur in a fully preemptive system as is the <abbr title="On-board Computer">OBC</abbr>. Now let's see what we can do to improve the situation and make our maneuver execution deterministic.
As a first step, we could execute our <code>pl_thr_task</code> only when there is a maneuver sequence to execute and avoid looping around and wasting CPU time when there is nothing to execute. We can use a <abbr title="Operating System">OS</abbr> thread flag for this purpose which would signal the <code>pl_thr_task</code> only when a payload start operation is requested. Let's add the following code to our <code>pl_thr_start</code> function after we have performed the <code>memcpy</code> of the maneuver sequence to our internal buffer:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">...</span>
<span class="c1">// signal thruster OS task to process the new maneuvers</span>
<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">thruster_task</span><span class="p">,</span><span class="w"> </span><span class="n">NEW_MANEUVERS_AVL_FLAG</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div></td></tr></table></div>
Also place <code>NEW_MANEUVERS_AVL_FLAG</code> as a define at the top of the file like this:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#define NEW_MANEUVERS_AVL_FLAG          (0x01U)</span>
</code></pre></div></td></tr></table></div></p>
</li>
</ul>
<p>We will extend the <code>pl_thr_task</code> code to wait for the <code>NEW_MANEUVERS_AVL_FLAG</code> flag event before starting execution of the maneuver sequence. This way, our thread will be blocked until an actual start operation is requested to our payload which is what we wanted initially:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">thread_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// currently unused</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">thread_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsWait</span><span class="p">(</span><span class="n">NEW_MANEUVERS_AVL_FLAG</span><span class="p">,</span><span class="w"> </span><span class="n">osFlagsWaitAny</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread_flags</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_NONE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                    </span><span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">execute_thr_maneuver</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]);</span>

<span class="w">                    </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">2000U</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000U</span><span class="p">);</span><span class="w">     </span><span class="c1">// just in case we have continous errors reported by the osThreadFlagsWait() API</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<ul>
<li>So far, so good but we still have one potential flaw to address. We must avoid the possibility of interrupting our maneuver execution sequence from start to completion by accepting a new payload start configuration parameter, e.g. in case our schedule was incorrect and attempted to execute overlapping maneuver operations. We will again rely on the <abbr title="Operating System">OS</abbr> APIs for this. Let's use a mutex to enable a critical section in our task. The mutex will be released as soon as we finish our full maneuver sequence. That very same mutex shall also be used inside the <code>pl_thr_start</code> operation when a new request arrives asynchronously to our <code>pl_thr_task</code> function potentially interrupting it.</li>
</ul>
<p>We will allocate a mutex and initialize it in <code>pl_thr_init</code>. We will also initialize our maneuver sequence buffer just to make sure it always starts with some valid values inside.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">osMutexId_t</span><span class="w"> </span><span class="n">man_seq_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_init_cfg</span><span class="p">,</span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">p_pl_event_notify_t</span><span class="w"> </span><span class="n">p_event_notify_cb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">man_seq_lock</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">man_seq_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMutexNew</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maneuvers_seq</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_NONE</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">);</span><span class="w">  </span><span class="c1">// initialize the maneuver sequence</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Now let's put the mutex to use by creating critical sections inside <code>pl_thr_start</code> and <code>pl_thr_task</code> functions:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">osStatus_t</span><span class="w"> </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osError</span><span class="p">;</span>

<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STARTED</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMutexAcquire</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osOK</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lock_stat</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">memcpy</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">,</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="o">-&gt;</span><span class="n">p_config_data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">fmin</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">),</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osMutexRelease</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// signal thruster OS task to process the new maneuvers</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">thruster_task</span><span class="p">,</span><span class="w"> </span><span class="n">NEW_MANEUVERS_AVL_FLAG</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">osStatus_t</span><span class="w"> </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osError</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">thread_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// currently unused</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">thread_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsWait</span><span class="p">(</span><span class="n">NEW_MANEUVERS_AVL_FLAG</span><span class="p">,</span><span class="w"> </span><span class="n">osFlagsWaitAny</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread_flags</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMutexAcquire</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osOK</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lock_stat</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="o">++</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_NONE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                        </span><span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]))</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="n">execute_thr_maneuver</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]);</span>

<span class="w">                        </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">2000U</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osMutexRelease</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000U</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>Finally, we shall execute an empty maneuver on the <code>pl_thr_stop</code> function:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_stop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">pl_op_stop_mode_t</span><span class="w"> </span><span class="n">stop_mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STOPPED</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// stop the active maneuver (if any)</span>
<span class="w">    </span><span class="n">execute_thr_maneuver</span><span class="p">(</span><span class="n">PL_THR_MAN_NONE</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>You can find the full source code to our thruster payload here as a reference:</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;es_cdef.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cmsis_os2.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;if_payload_control.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;trace.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;math.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;string.h&quot;</span>

<span class="cp">#define MAX_MANEUVERS_CNT               (16U)</span>
<span class="cp">#define NEW_MANEUVERS_AVL_FLAG          (0x01U)</span>

<span class="cm">/** @brief List of maneuvers supported by the thruster */</span>
<span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PL_THR_MAN_NONE</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_SGL_THRUST_SHORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_SGL_THRUST_LONG</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_DBL_THRUST_SHORT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_DBL_THRUST_LONG</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_INCR_THRUST_HALF_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_INCR_THRUST_ONE_S</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="mi">7</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">p_pl_event_notify_t</span><span class="w"> </span><span class="n">p_event_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p_pl_event_notify_t</span><span class="p">)</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_NOT_INIT</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">];</span>
<span class="k">static</span><span class="w"> </span><span class="n">osMutexId_t</span><span class="w"> </span><span class="n">man_seq_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">osThreadId_t</span><span class="w"> </span><span class="n">thruster_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">);</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute_thr_maneuver</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_id</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fire_event</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="n">to_state</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p_event_cbk</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">p_event_cbk</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">to_state</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_init_cfg</span><span class="p">,</span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">p_pl_event_notify_t</span><span class="w"> </span><span class="n">p_event_notify_cb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">osThreadAttr_t</span><span class="w"> </span><span class="n">task_attr</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">attr_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadDetached</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pl_thr_task&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">priority</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">osPriorityNormal</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cb_mem</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cb_size</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">stack_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">stack_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000U</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">instance_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_init_cfg</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">man_seq_lock</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">man_seq_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMutexNew</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">thruster_task</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">thruster_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl_thr_task</span><span class="p">,</span>
<span class="w">                                    </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                                    </span><span class="o">&amp;</span><span class="n">task_attr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STOPPED</span><span class="p">;</span>
<span class="w">    </span><span class="n">p_event_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_event_notify_cb</span><span class="p">;</span>

<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maneuvers_seq</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_NONE</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">);</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_deinit</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_NOT_INIT</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">pl_config_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">osStatus_t</span><span class="w"> </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osError</span><span class="p">;</span>

<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STARTED</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMutexAcquire</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osOK</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lock_stat</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">memcpy</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">,</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="o">-&gt;</span><span class="n">p_config_data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">fmin</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">),</span><span class="w"> </span><span class="n">p_start_cfg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osMutexRelease</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// signal thruster OS task to process the new maneuvers</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">thruster_task</span><span class="p">,</span><span class="w"> </span><span class="n">NEW_MANEUVERS_AVL_FLAG</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_op_status_t</span><span class="w"> </span><span class="nf">pl_thr_stop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">pl_op_stop_mode_t</span><span class="w"> </span><span class="n">stop_mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">stop_mode</span><span class="p">;</span>

<span class="w">    </span><span class="n">current_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_STATE_STOPPED</span><span class="p">;</span>

<span class="w">    </span><span class="n">fire_event</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span><span class="w"> </span><span class="n">current_state</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// stop the active maneuver (if any)</span>
<span class="w">    </span><span class="n">execute_thr_maneuver</span><span class="p">(</span><span class="n">PL_THR_MAN_NONE</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PL_OP_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">pl_state_t</span><span class="w"> </span><span class="nf">pl_thr_get_active_state</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">instance_id</span><span class="p">;</span><span class="w">     </span><span class="c1">// we support only one payload instance here</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">current_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">pl_thr_get_last_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pl_instance_id_t</span><span class="w"> </span><span class="n">instance_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">instance_id</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pl_thr_task</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">osStatus_t</span><span class="w"> </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osError</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">thread_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// currently unused</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">p_task_arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">thread_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsWait</span><span class="p">(</span><span class="n">NEW_MANEUVERS_AVL_FLAG</span><span class="p">,</span><span class="w"> </span><span class="n">osFlagsWaitAny</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread_flags</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">lock_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMutexAcquire</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">,</span><span class="w"> </span><span class="n">osWaitForever</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osOK</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lock_stat</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_MANEUVERS_CNT</span><span class="p">;</span><span class="w"> </span><span class="n">man_idx</span><span class="o">++</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_NONE</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                        </span><span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">PL_THR_MAN_MAX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]))</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="n">execute_thr_maneuver</span><span class="p">(</span><span class="n">maneuvers_seq</span><span class="p">[</span><span class="n">man_idx</span><span class="p">]);</span>

<span class="w">                        </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">2000U</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">osMutexRelease</span><span class="p">(</span><span class="n">man_seq_lock</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000U</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute_thr_maneuver</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">man_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">maneuver_names</span><span class="p">[</span><span class="n">PL_THR_MAN_MAX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;NONE&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;SGL_THRUST_SHORT&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;SGL_THRUST_LONG&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;DBL_THRUST_SHORT&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;DBL_THRUST_LONG&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;INCR_THRUST_HALF_S&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;INCR_THRUST_ONE_S&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">man_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PL_THR_MAN_MAX</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ES_TRACE_INFO</span><span class="p">(</span><span class="s">&quot;executing maneuver &#39;%s&#39;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maneuver_names</span><span class="p">[(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">man_id</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ES_TRACE_ERROR</span><span class="p">(</span><span class="s">&quot;invalid maneuver id &#39;%d&#39;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">man_id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">pl_control_if_t</span><span class="w"> </span><span class="n">pl_thr_if</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_init</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">deinit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_deinit</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_start</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_stop</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_get_active_state</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_last_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl_thr_get_last_error</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Good work!</p>
<p>Now our payload thruster can be operated either via the <code>ConOps.fidl::addNewScheduleRecord</code> operation or through the <abbr title="EnduroSat Digital Ground Station">DGS</abbr> Web <abbr title="Graphic User Interface">GUI</abbr> which is able to prepare an <abbr title="On-board Computer">OBC</abbr> on-board schedule for autonomous execution in orbit.</p>
<p><img alt="❗" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2757.svg" title=":exclamation:" /> Please have in mind that the on-board scheduler operation is very tightly coupled with the satellite operational modes and in order to properly execute these schedules, there are system conditions which must be fulfilled in advance <em>(e.g. such as optimal battery voltage levels and correct <abbr title="Attitude Determination and Control System">ADCS</abbr> pointing)</em>, otherwise your payload implementation will not be called.</p>
<p>Let's recap on what we learned in this chapter:</p>
<ul>
<li>We explored how user payload scheduling in the <abbr title="On-board Computer">OBC</abbr> works.</li>
<li>We looked at the standard interfaces a user payload must implement in order to be used with the <abbr title="On-board Computer">OBC</abbr> on-board scheduler.</li>
<li>We implemented a simple user payload module for a thruster based on the <abbr title="On-board Computer">OBC</abbr> SDK templates.</li>
<li>We saw how we can use specific payload configuration arguments supplied through the standard payload <code>if_payload_control.h::start()</code> interface.</li>
<li>We extended the basic implementation by providing an <abbr title="Operating System">OS</abbr> thread to handle our more complex payload operations.</li>
<li>We looked into some best practices on how to protect our payload operation if it must be run in a separate <abbr title="Operating System">OS</abbr> thread.</li>
<li>We used the <abbr title="On-board Computer">OBC</abbr> SDK <code>libtrace</code> library to trace our payload operations.</li>
</ul>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="footer.title">
      
        
        <a href="devguide_conops.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Concept of Operations" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Concept of Operations
            </div>
          </div>
        </a>
      
      
        
        <a href="devguide_aocs.html" class="md-footer__link md-footer__link--next" aria-label="Next: Attitude and Orbit Control" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Attitude and Orbit Control
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <i>Privileged and confidential</i>
          </div>
        
      </div>
      <div class="md-social">
  
    
    
    
    
    <a href="https://www.linkedin.com/company/endurosat/" target="_blank" rel="noopener" title="EnduroSat on LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
<script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.annotate", "search.suggest", "search.highlight", "search.share", "navigation.tabs", "navigation.top", "toc.integrate"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    


    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>